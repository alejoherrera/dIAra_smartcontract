<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dIAra V2 - Transparencia en Obras P√∫blicas</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .contract-info {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        
        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .message-display {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            word-wrap: break-word;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .debug-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>dIAra V2</h1>
            <p>Transparencia en Obras P√∫blicas con IoT, IA, Blockchain e IPFS</p>
        </div>

        <div class="contract-info">
            <strong>Contrato:</strong> 0x4b3072893f161ecb4b7f4794b6a8a036eb22aa27<br>
            <strong>Red:</strong> Sepolia Testnet<br>
            <strong>Estado:</strong> <span id="contractStatus">Verificando...</span>
        </div>

        <!-- Secci√≥n de Wallet -->
        <div class="wallet-section">
            <h3>üîó Conectar Wallet</h3>
            <p id="walletStatus">Estado: Desconectado</p>
            <button id="connectWallet" class="btn" onclick="connectWallet()">Conectar MetaMask</button>
            <button id="diagnoseBtn" class="btn btn-secondary" onclick="runDiagnosis()">üîç Diagn√≥stico</button>
        </div>

        <!-- Mensajes de estado -->
        <div id="statusMessages"></div>

        <!-- Secci√≥n de diagn√≥stico -->
        <div id="diagnosisSection" class="debug-section" style="display:none;">
            <h4>üîç Resultados del Diagn√≥stico:</h4>
            <div id="diagnosisResults"></div>
        </div>

        <!-- Secci√≥n de pruebas -->
        <div class="form-section">
            <h3>üß™ Pruebas B√°sicas</h3>
            <button class="btn btn-secondary" onclick="testMetaMask()">Probar MetaMask</button>
            <button class="btn btn-secondary" onclick="testContract()">Probar Contrato</button>
            <button class="btn btn-secondary" onclick="getStats()">Ver Estad√≠sticas</button>
            
            <div id="testResults" class="message-display" style="display:none;"></div>
        </div>

        <!-- Crear proyecto simple -->
        <div class="form-section" style="display:none;" id="adminSection">
            <h3>üèóÔ∏è Crear Proyecto (Solo Administradores)</h3>
            
            <div class="form-group">
                <label for="numeroProyecto">N√∫mero de Proyecto:</label>
                <input type="number" id="numeroProyecto" placeholder="2025001" value="2025001">
            </div>
            
            <div class="form-group">
                <label for="nombreProyecto">Nombre del Proyecto:</label>
                <input type="text" id="nombreProyecto" placeholder="Construcci√≥n Puente Central" value="Puente Central">
            </div>
            
            <div class="form-group">
                <label for="responsable">Responsable (tu direcci√≥n actual):</label>
                <input type="text" id="responsable" placeholder="0x..." readonly>
            </div>
            
            <button class="btn btn-success" onclick="createProject()">Crear Proyecto</button>
        </div>
    </div>

    <script>
        console.log('üöÄ dIAra V2 iniciando...');
        
        // Configuraci√≥n
        const CONTRACT_ADDRESS = "0x4b3072893f161ecb4b7f4794b6a8a036eb22aa27";
        const SEPOLIA_CHAIN_ID = "0xaa36a7"; // 11155111 en hexadecimal
        
        // ABI simplificado
        const CONTRACT_ABI = [
            "function crearProyecto(uint256 _numeroProyecto, string _nombreProyecto, string _ubicacion, string _descripcion, address _responsable, uint256 _fechaFin) public",
            "function totalProyectos() public view returns (uint256)",
            "function totalMensajes() public view returns (uint256)",
            "function esAdministrador(address) public view returns (bool)",
            "function obtenerEstadisticas() public view returns (uint256, uint256, uint256)"
        ];

        // Variables globales
        let provider = null;
        let signer = null;
        let contract = null;
        let userAccount = null;

        // Funci√≥n para mostrar mensajes
        function showStatus(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            const statusMessages = document.getElementById('statusMessages');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusMessages.innerHTML = '';
            statusMessages.appendChild(statusDiv);
            
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        // Verificar al cargar la p√°gina
        window.addEventListener('load', function() {
            console.log('‚úÖ P√°gina cargada, verificando MetaMask...');
            checkInitialState();
        });

        function checkInitialState() {
            if (typeof window.ethereum !== 'undefined') {
                showStatus('‚úÖ MetaMask detectado', 'success');
                document.getElementById('contractStatus').textContent = 'MetaMask disponible';
                
                // Verificar si ya est√° conectado
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            showStatus(`Wallet ya conectada: ${accounts[0].slice(0,6)}...${accounts[0].slice(-4)}`, 'info');
                            userAccount = accounts[0];
                            document.getElementById('walletStatus').textContent = `Conectado: ${userAccount.slice(0,6)}...${userAccount.slice(-4)}`;
                        }
                    })
                    .catch(err => console.error('Error verificando cuentas:', err));
            } else {
                showStatus('‚ùå MetaMask no detectado. Instala MetaMask primero', 'error');
                document.getElementById('contractStatus').textContent = 'MetaMask requerido';
                document.getElementById('connectWallet').disabled = true;
            }
        }

        // Funci√≥n de diagn√≥stico
        async function runDiagnosis() {
            console.log('üîç Iniciando diagn√≥stico...');
            
            const diagnosisSection = document.getElementById('diagnosisSection');
            const results = document.getElementById('diagnosisResults');
            
            diagnosisSection.style.display = 'block';
            results.innerHTML = '<div class="loading"></div> Ejecutando diagn√≥stico...';
            
            let diagnosis = '';
            
            try {
                // 1. Verificar MetaMask
                if (typeof window.ethereum !== 'undefined') {
                    diagnosis += '‚úÖ MetaMask: Instalado<br>';
                    console.log('‚úÖ MetaMask detectado');
                    
                    // 2. Verificar cuentas
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) {
                            diagnosis += `‚úÖ Cuenta: ${accounts[0]}<br>`;
                            console.log('‚úÖ Cuenta:', accounts[0]);
                        } else {
                            diagnosis += '‚ö†Ô∏è Cuenta: No conectada<br>';
                            console.log('‚ö†Ô∏è No hay cuentas conectadas');
                        }
                    } catch (e) {
                        diagnosis += `‚ùå Error cuentas: ${e.message}<br>`;
                        console.error('‚ùå Error verificando cuentas:', e);
                    }
                    
                    // 3. Verificar red
                    try {
                        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                        const chainIdDecimal = parseInt(chainId, 16);
                        console.log('üîó Chain ID:', chainId, '(', chainIdDecimal, ')');
                        
                        if (chainId === SEPOLIA_CHAIN_ID) {
                            diagnosis += '‚úÖ Red: Sepolia Testnet<br>';
                        } else {
                            diagnosis += `‚ùå Red incorrecta: ${chainIdDecimal}. Se requiere Sepolia (11155111)<br>`;
                        }
                    } catch (e) {
                        diagnosis += `‚ùå Error red: ${e.message}<br>`;
                        console.error('‚ùå Error verificando red:', e);
                    }
                    
                    // 4. Verificar contrato
                    try {
                        const tempProvider = new ethers.BrowserProvider(window.ethereum);
                        const code = await tempProvider.getCode(CONTRACT_ADDRESS);
                        
                        if (code !== '0x') {
                            diagnosis += '‚úÖ Contrato: Encontrado<br>';
                            console.log('‚úÖ Contrato desplegado');
                            
                            // Probar funci√≥n
                            const tempContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);
                            const totalProyectos = await tempContract.totalProyectos();
                            diagnosis += `‚úÖ Funci√≥n: ${totalProyectos} proyectos registrados<br>`;
                            console.log('‚úÖ Total proyectos:', totalProyectos.toString());
                            
                        } else {
                            diagnosis += '‚ùå Contrato: No encontrado<br>';
                            console.error('‚ùå Contrato no encontrado');
                        }
                    } catch (e) {
                        diagnosis += `‚ùå Error contrato: ${e.message}<br>`;
                        console.error('‚ùå Error verificando contrato:', e);
                    }
                    
                } else {
                    diagnosis += '‚ùå MetaMask: No instalado<br>';
                    diagnosis += 'üí° Instalar: <a href="https://metamask.io" target="_blank">metamask.io</a><br>';
                }
                
                diagnosis += '<br><strong>üîß Instrucciones:</strong><br>';
                diagnosis += '1. Instalar MetaMask si no lo tienes<br>';
                diagnosis += '2. Conectar wallet<br>';
                diagnosis += '3. Cambiar a red Sepolia<br>';
                diagnosis += '4. Conseguir ETH de prueba en sepoliafaucet.com<br>';
                
            } catch (error) {
                diagnosis += `‚ùå Error general: ${error.message}<br>`;
                console.error('‚ùå Error en diagn√≥stico:', error);
            }
            
            results.innerHTML = diagnosis;
        }

        // Conectar wallet simplificado
        async function connectWallet() {
            console.log('üîó Intentando conectar wallet...');
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('MetaMask no est√° instalado', 'error');
                    return;
                }

                showStatus('Conectando wallet...', 'info');
                
                // Solicitar cuentas
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                console.log('‚úÖ Cuentas obtenidas:', accounts);
                
                if (accounts.length === 0) {
                    showStatus('No se seleccion√≥ ninguna cuenta', 'error');
                    return;
                }
                
                userAccount = accounts[0];
                
                // Verificar red
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                console.log('üîó Chain ID actual:', chainId);
                
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    showStatus('Cambiando a red Sepolia...', 'info');
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }]
                        });
                    } catch (switchError) {
                        console.error('Error cambiando red:', switchError);
                        showStatus('Por favor cambia manualmente a red Sepolia en MetaMask', 'error');
                        return;
                    }
                }
                
                // Configurar provider y contrato
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Actualizar UI
                document.getElementById('walletStatus').textContent = `Conectado: ${userAccount.slice(0,6)}...${userAccount.slice(-4)}`;
                document.getElementById('connectWallet').textContent = '‚úÖ Conectado';
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('responsable').value = userAccount;
                
                showStatus('¬°Wallet conectada exitosamente!', 'success');
                
                // Verificar si es administrador
                checkAdmin();
                
            } catch (error) {
                console.error('‚ùå Error conectando:', error);
                
                let errorMsg = 'Error conectando wallet: ';
                if (error.code === 4001) {
                    errorMsg += 'Conexi√≥n rechazada por el usuario';
                } else {
                    errorMsg += error.message;
                }
                
                showStatus(errorMsg, 'error');
            }
        }

        // Verificar permisos de administrador
        async function checkAdmin() {
            try {
                if (!contract || !userAccount) return;
                
                const isAdmin = await contract.esAdministrador(userAccount);
                console.log('üë§ Es administrador:', isAdmin);
                
                if (isAdmin) {
                    document.getElementById('adminSection').style.display = 'block';
                    showStatus('‚úÖ Eres administrador - Puedes crear proyectos', 'success');
                } else {
                    showStatus('‚ÑπÔ∏è Usuario regular - Puedes ver estad√≠sticas', 'info');
                }
                
            } catch (error) {
                console.error('Error verificando admin:', error);
            }
        }

        // Pruebas individuales
        async function testMetaMask() {
            const results = document.getElementById('testResults');
            results.style.display = 'block';
            
            if (typeof window.ethereum !== 'undefined') {
                results.innerHTML = '‚úÖ MetaMask est√° instalado y disponible';
            } else {
                results.innerHTML = '‚ùå MetaMask no detectado';
            }
        }

        async function testContract() {
            const results = document.getElementById('testResults');
            results.style.display = 'block';
            results.innerHTML = 'Probando contrato...';
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    results.innerHTML = '‚ùå MetaMask requerido para probar contrato';
                    return;
                }
                
                const tempProvider = new ethers.BrowserProvider(window.ethereum);
                const tempContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);
                
                const totalProyectos = await tempContract.totalProyectos();
                results.innerHTML = `‚úÖ Contrato funcional. Total proyectos: ${totalProyectos}`;
                
            } catch (error) {
                console.error('Error probando contrato:', error);
                results.innerHTML = `‚ùå Error probando contrato: ${error.message}`;
            }
        }

        async function getStats() {
            const results = document.getElementById('testResults');
            results.style.display = 'block';
            results.innerHTML = 'Obteniendo estad√≠sticas...';
            
            try {
                if (typeof window.ethereum === 'undefined') {
                    results.innerHTML = '‚ùå MetaMask requerido';
                    return;
                }
                
                const tempProvider = new ethers.BrowserProvider(window.ethereum);
                const tempContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);
                
                const [totalProyectos, totalDetecciones, proyectosActivos] = await tempContract.obtenerEstadisticas();
                
                results.innerHTML = `
                    <strong>üìä Estad√≠sticas del Sistema:</strong><br>
                    ‚Ä¢ Total proyectos: ${totalProyectos}<br>
                    ‚Ä¢ Total detecciones: ${totalDetecciones}<br>
                    ‚Ä¢ Proyectos activos: ${proyectosActivos}
                `;
                
            } catch (error) {
                console.error('Error obteniendo estad√≠sticas:', error);
                results.innerHTML = `‚ùå Error: ${error.message}`;
            }
        }

        // Crear proyecto
        async function createProject() {
            try {
                if (!contract) {
                    showStatus('Conecta tu wallet primero', 'error');
                    return;
                }
                
                const numeroProyecto = document.getElementById('numeroProyecto').value;
                const nombreProyecto = document.getElementById('nombreProyecto').value;
                const responsable = document.getElementById('responsable').value;
                
                if (!numeroProyecto || !nombreProyecto || !responsable) {
                    showStatus('Completa todos los campos', 'error');
                    return;
                }
                
                showStatus('Creando proyecto...', 'info');
                
                const fechaFin = Math.floor(Date.now() / 1000) + (30 * 24 * 60 * 60); // 30 d√≠as
                
                const tx = await contract.crearProyecto(
                    parseInt(numeroProyecto),
                    nombreProyecto,
                    "Ubicaci√≥n por defecto",
                    "Descripci√≥n por defecto",
                    responsable,
                    fechaFin
                );
                
                showStatus(`Transacci√≥n enviada: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                showStatus(`‚úÖ Proyecto creado en bloque ${receipt.blockNumber}`, 'success');
                
            } catch (error) {
                console.error('Error creando proyecto:', error);
                showStatus(`Error: ${error.reason || error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
