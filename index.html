<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>dIAra - Transparencia en Obras P√∫blicas con IPFS</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.1/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/ipfs-http-client@60.0.1/dist/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .wallet-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group input[type="file"] {
            padding: 8px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9a00 0%, #ffad00 100%);
        }
        
        .message-display {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
            word-wrap: break-word;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .contract-info {
            background: #f1f3f4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 15px 25px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .tab.active {
            background: #667eea;
            color: white;
        }
        
        .tab:hover {
            background: #e9ecef;
        }
        
        .tab.active:hover {
            background: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .ipfs-image {
            max-width: 300px;
            max-height: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .project-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .project-card.active {
            border-color: #28a745;
        }
        
        .project-card.inactive {
            border-color: #dc3545;
            opacity: 0.7;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat h3 {
            font-size: 2em;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat p {
            color: #666;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>dIAra V2</h1>
            <p>Transparencia en Obras P√∫blicas con IoT, IA, Blockchain e IPFS</p>
        </div>

        <div class="contract-info">
            <strong>Contrato:</strong> <span id="contractAddress">0x4b3072893f161ecb4b7f4794b6a8a036eb22aa27</span><br>
            <strong>Red:</strong> Sepolia Testnet<br>
            <strong>IPFS:</strong> <span id="ipfsStatus">Conectado</span>
        </div>

        <!-- Secci√≥n de Wallet mejorada -->
        <div class="wallet-section">
            <h3>üîó Conectar Wallet</h3>
            <p id="walletStatus">Estado: Desconectado</p>
            <button id="connectWallet" class="btn">Conectar MetaMask</button>
            <button id="diagnoseBtn" class="btn btn-secondary" onclick="runDiagnosis()">üîç Diagn√≥stico</button>
            
            <div id="diagnosisResults" style="display:none; margin-top: 15px; font-size: 14px;"></div>
        </div>

        <!-- Mensajes de estado -->
        <div id="statusMessages"></div>

        <!-- Estad√≠sticas generales -->
        <div class="stats" id="statsContainer" style="display:none;">
            <div class="stat">
                <h3 id="totalProjects">0</h3>
                <p>Proyectos</p>
            </div>
            <div class="stat">
                <h3 id="activeProjects">0</h3>
                <p>Activos</p>
            </div>
            <div class="stat">
                <h3 id="totalDetections">0</h3>
                <p>Detecciones</p>
            </div>
        </div>

        <!-- Pesta√±as -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('proyectos')">üìã Proyectos</button>
            <button class="tab" onclick="showTab('detecciones')">üìù Detecciones</button>
            <button class="tab" onclick="showTab('consultas')">üìñ Consultas</button>
        </div>

        <!-- Contenido de Proyectos -->
        <div id="proyectos" class="tab-content active">
            <div class="form-section">
                <h3>üèóÔ∏è Crear Nuevo Proyecto</h3>
                
                <div class="form-group">
                    <label for="numeroProyecto">N√∫mero de Proyecto:</label>
                    <input type="number" id="numeroProyecto" placeholder="Ej: 2025001" min="1">
                </div>
                
                <div class="form-group">
                    <label for="nombreProyecto">Nombre del Proyecto:</label>
                    <input type="text" id="nombreProyecto" placeholder="Ej: Construcci√≥n Puente Central">
                </div>
                
                <div class="form-group">
                    <label for="ubicacion">Ubicaci√≥n:</label>
                    <input type="text" id="ubicacion" placeholder="Ej: Av. Principal, Zona 1">
                </div>
                
                <div class="form-group">
                    <label for="descripcion">Descripci√≥n:</label>
                    <textarea id="descripcion" rows="3" placeholder="Descripci√≥n del proyecto..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="responsable">Responsable (Direcci√≥n):</label>
                    <input type="text" id="responsable" placeholder="0x...">
                </div>
                
                <div class="form-group">
                    <label for="fechaFin">Fecha de Finalizaci√≥n:</label>
                    <input type="date" id="fechaFin">
                </div>
                
                <button id="createProject" class="btn btn-success" disabled>Crear Proyecto</button>
            </div>

            <div class="form-section">
                <h3>üìã Proyectos Existentes</h3>
                <button id="loadProjects" class="btn btn-secondary">Cargar Proyectos</button>
                <div id="projectsList" class="grid"></div>
            </div>
        </div>

        <!-- Contenido de Detecciones -->
        <div id="detecciones" class="tab-content">
            <div class="form-section">
                <h3>üìù Registrar Nueva Detecci√≥n</h3>
                
                <div class="form-group">
                    <label for="proyectoSelect">Proyecto:</label>
                    <select id="proyectoSelect">
                        <option value="">Selecciona un proyecto</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="imagenFile">Imagen para An√°lisis:</label>
                    <input type="file" id="imagenFile" accept="image/*">
                    <img id="imagePreview" class="image-preview" style="display:none;">
                </div>
                
                <div class="form-group">
                    <label for="deteccionPersona">Detecci√≥n de Personas:</label>
                    <input type="text" id="deteccionPersona" placeholder="Ej: person: 1/.6, 1/.7, 1/.65">
                </div>
                
                <div class="form-group">
                    <label for="equipos">Equipos Detectados:</label>
                    <input type="text" id="equipos" placeholder="Ej: aplanadora:1/.8; vagoneta:1/.7">
                </div>
                
                <div class="form-group">
                    <label for="fechaRegistro">Fecha de Registro:</label>
                    <input type="date" id="fechaRegistro">
                </div>
                
                <button id="uploadToIPFS" class="btn btn-warning" disabled>üì§ Subir a IPFS</button>
                <button id="registerDetection" class="btn" disabled>Registrar Detecci√≥n</button>
                
                <div id="ipfsHash" class="message-display" style="display:none;"></div>
            </div>
        </div>

        <!-- Contenido de Consultas -->
        <div id="consultas" class="tab-content">
            <div class="form-section">
                <h3>üìñ Consultar Datos</h3>
                
                <div class="form-group">
                    <label for="consultaProyecto">Proyecto a Consultar:</label>
                    <select id="consultaProyecto">
                        <option value="">Selecciona un proyecto</option>
                    </select>
                </div>
                
                <button id="getProjectInfo" class="btn btn-secondary">Info del Proyecto</button>
                <button id="getProjectDetections" class="btn btn-secondary">Detecciones del Proyecto</button>
                <button id="getLastDetection" class="btn btn-secondary">√öltima Detecci√≥n</button>
                <button id="getStats" class="btn btn-secondary">Estad√≠sticas</button>
                
                <div id="queryResults"></div>
            </div>

            <div class="form-section">
                <h3>üñºÔ∏è Ver Imagen desde IPFS</h3>
                
                <div class="form-group">
                    <label for="ipfsHashInput">Hash IPFS:</label>
                    <input type="text" id="ipfsHashInput" placeholder="QmXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX">
                </div>
                
                <button id="loadIPFSImage" class="btn btn-secondary">Cargar Imagen</button>
                
                <div id="ipfsImageContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const SEPOLIA_CHAIN_ID = "0xaa36a7";
        let CONTRACT_ADDRESS = ""; // Se establecer√° cuando se despliegue el contrato
        
        // ABI del contrato (versi√≥n completa)
        const CONTRACT_ABI = [
            "function crearProyecto(uint256 _numeroProyecto, string _nombreProyecto, string _ubicacion, string _descripcion, address _responsable, uint256 _fechaFin) public",
            "function registrarDeteccionIA(uint256 _numeroProyecto, string _deteccionPersona, string _equipos, string _fechaRegistro, string _imagenIPFS) public",
            "function obtenerProyecto(uint256 _numeroProyecto) public view returns (string, string, string, address, uint256, uint256, bool, uint256)",
            "function obtenerDeteccion(uint256 _id) public view returns (uint256, string, string, string, string, address, uint256)",
            "function leerUltimaDeteccion() public view returns (uint256, string, string, string, string, address, uint256)",
            "function obtenerDeteccionesProyecto(uint256 _numeroProyecto) public view returns (uint256[])",
            "function obtenerEstadisticas() public view returns (uint256, uint256, uint256)",
            "function obtenerImagenIPFS(uint256 _idDeteccion) public view returns (string)",
            "function totalMensajes() public view returns (uint256)",
            "function totalProyectos() public view returns (uint256)",
            "function administradores(address) public view returns (bool)"
        ];

        // Variables globales
        let provider = null;
        let signer = null;
        let contract = null;
        let userAccount = null;
        let ipfsClient = null;

            <script>
        // Configuraci√≥n del contrato
        const CONTRACT_ADDRESS = "0x4b3072893f161ecb4b7f4794b6a8a036eb22aa27";
        const SEPOLIA_CHAIN_ID = "0xaa36a7";
        
        // ABI del contrato actualizado
        const CONTRACT_ABI = [
            "function crearProyecto(uint256 _numeroProyecto, string _nombreProyecto, string _ubicacion, string _descripcion, address _responsable, uint256 _fechaFin) public",
            "function registrarDeteccionIA(uint256 _numeroProyecto, string _deteccionPersona, string _equipos, string _fechaRegistro, string _imagenIPFS) public",
            "function obtenerProyectoBasico(uint256 _numeroProyecto) public view returns (string, string, string, address)",
            "function obtenerProyectoEstado(uint256 _numeroProyecto) public view returns (uint256, uint256, bool, uint256)",
            "function obtenerResumenProyecto(uint256 _numeroProyecto) public view returns (uint256, string, bool, uint256)",
            "function leerUltimaDeteccion() public view returns (uint256, string, string, string, string, address, uint256)",
            "function obtenerDeteccion(uint256 _id) public view returns (uint256, string, string, string, string, address, uint256)",
            "function obtenerDeteccionesProyecto(uint256 _numeroProyecto) public view returns (uint256[])",
            "function obtenerEstadisticas() public view returns (uint256, uint256, uint256)",
            "function obtenerImagenIPFS(uint256 _idDeteccion) public view returns (string)",
            "function obtenerDeteccionesLimitadas(uint256 _inicio, uint256 _limite) public view returns (uint256[])",
            "function totalMensajes() public view returns (uint256)",
            "function totalProyectos() public view returns (uint256)",
            "function esAdministrador(address) public view returns (bool)",
            "function agregarAdministrador(address _admin) public",
            "function pausarContrato() public",
            "function reanudarContrato() public",
            "function leerUltimoMensaje() public view returns (string)"
        ];

        // Variables globales
        let provider = null;
        let signer = null;
        let contract = null;
        let userAccount = null;
        let currentImageFile = null;
        let currentIPFSHash = null;

        // Configuraci√≥n IPFS usando Pinata (servicio gratuito)
        const PINATA_API_KEY = "tu_pinata_api_key"; // Reemplazar con tu API key
        const PINATA_SECRET_KEY = "tu_pinata_secret_key"; // Reemplazar con tu secret key

        // Esperar a que el DOM est√© cargado
        document.addEventListener('DOMContentLoaded', function() {
            console.log('dIAra V2 inicializando...');
            initializeApp();
        });

        // Inicializar la aplicaci√≥n
        function initializeApp() {
            // Obtener elementos del DOM
            const connectWalletBtn = document.getElementById('connectWallet');
            const walletStatus = document.getElementById('walletStatus');
            
            // Event listeners principales
            connectWalletBtn.addEventListener('click', connectWallet);
            document.getElementById('createProject').addEventListener('click', createProject);
            document.getElementById('loadProjects').addEventListener('click', loadProjects);
            document.getElementById('imagenFile').addEventListener('change', previewImage);
            document.getElementById('uploadToIPFS').addEventListener('click', uploadToIPFS);
            document.getElementById('registerDetection').addEventListener('click', registerDetection);
            document.getElementById('getProjectInfo').addEventListener('click', getProjectInfo);
            document.getElementById('getProjectDetections').addEventListener('click', getProjectDetections);
            document.getElementById('getLastDetection').addEventListener('click', getLastDetection);
            document.getElementById('getStats').addEventListener('click', loadStats);
            document.getElementById('loadIPFSImage').addEventListener('click', loadIPFSImage);

            // Configurar fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('fechaRegistro').value = today;

            // Verificar MetaMask
            checkMetaMask();
            
            // Cargar estad√≠sticas iniciales
            setTimeout(loadStats, 1000);
        }

        // Funciones de utilidad
        function showStatus(message, type = 'info') {
            const statusMessages = document.getElementById('statusMessages');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusMessages.innerHTML = '';
            statusMessages.appendChild(statusDiv);
            
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        function showTab(tabName) {
            // Ocultar todos los contenidos
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));
            
            // Desactivar todas las pesta√±as
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Mostrar el contenido seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Activar la pesta√±a seleccionada
            event.target.classList.add('active');
            
            // Cargar datos espec√≠ficos seg√∫n la pesta√±a
            if (tabName === 'proyectos') {
                loadProjectsForSelects();
            } else if (tabName === 'detecciones') {
                loadProjectsForSelects();
            } else if (tabName === 'consultas') {
                loadProjectsForSelects();
            }
        }

        // Verificar MetaMask y conexi√≥n
        function checkMetaMask() {
            const connectBtn = document.getElementById('connectWallet');
            
            if (typeof window.ethereum !== 'undefined') {
                showStatus('‚úÖ MetaMask detectado. Verificando configuraci√≥n...', 'info');
                
                // Verificar si ya est√° conectado
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            showStatus(`üîó Wallet ya conectada: ${accounts[0].slice(0,6)}...${accounts[0].slice(-4)}`, 'success');
                            autoConnectWallet();
                        } else {
                            showStatus('üîå Haz clic en "Conectar MetaMask" para continuar', 'info');
                        }
                    })
                    .catch(error => {
                        console.error('Error verificando cuentas:', error);
                        showStatus('‚ö†Ô∏è Error verificando MetaMask: ' + error.message, 'error');
                    });
                
                return true;
            } else {
                showStatus('‚ùå MetaMask no detectado. Inst√°lalo desde metamask.io', 'error');
                connectBtn.disabled = true;
                connectBtn.textContent = 'Instalar MetaMask';
                connectBtn.onclick = () => window.open('https://metamask.io/download/', '_blank');
                return false;
            }
        }

        // Auto-conectar si ya estaba conectado
        async function autoConnectWallet() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } catch (error) {
                console.error('Error en auto-conexi√≥n:', error);
            }
        }

        // Conectar wallet con diagn√≥stico mejorado
        async function connectWallet() {
            try {
                console.log('üîÑ Iniciando conexi√≥n de wallet...');
                
                if (!window.ethereum) {
                    showStatus('‚ùå MetaMask no est√° disponible', 'error');
                    return;
                }

                showStatus('üîå Solicitando conexi√≥n a MetaMask...', 'info');
                
                // Solicitar cuentas
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                console.log('‚úÖ Cuentas obtenidas:', accounts);
                
                if (accounts.length === 0) {
                    showStatus('‚ùå No se seleccion√≥ ninguna cuenta', 'error');
                    return;
                }
                
                // Verificar chain ID
                const chainId = await window.ethereum.request({
                    method: 'eth_chainId'
                });
                
                console.log('üîó Chain ID actual:', chainId, 'Requerido:', SEPOLIA_CHAIN_ID);
                
                if (chainId !== SEPOLIA_CHAIN_ID) {
                    showStatus('üîÑ Cambiando a red Sepolia...', 'info');
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }]
                        });
                        console.log('‚úÖ Red cambiada a Sepolia');
                    } catch (switchError) {
                        console.error('‚ùå Error cambiando red:', switchError);
                        
                        if (switchError.code === 4902) {
                            // Red no agregada, intentar agregarla
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: SEPOLIA_CHAIN_ID,
                                        chainName: 'Sepolia Test Network',
                                        nativeCurrency: {
                                            name: 'ETH',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://rpc.sepolia.org'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io']
                                    }]
                                });
                                console.log('‚úÖ Red Sepolia agregada');
                            } catch (addError) {
                                console.error('‚ùå Error agregando red:', addError);
                                showStatus('‚ùå Error agregando red Sepolia. Agr√©gala manualmente en MetaMask', 'error');
                                return;
                            }
                        } else {
                            showStatus('‚ùå Por favor cambia a la red Sepolia manualmente en MetaMask', 'error');
                            return;
                        }
                    }
                }
                
                // Configurar provider y contrato
                showStatus('üîß Configurando conexi√≥n...', 'info');
                
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                userAccount = accounts[0];
                
                console.log('‚úÖ Wallet configurada:', userAccount);
                
                // Verificar saldo
                const balance = await provider.getBalance(userAccount);
                const balanceEth = ethers.formatEther(balance);
                console.log('üí∞ Saldo:', balanceEth, 'ETH');
                
                if (parseFloat(balanceEth) < 0.001) {
                    showStatus('‚ö†Ô∏è Saldo bajo. Necesitas ETH de Sepolia para las transacciones', 'error');
                }
                
                // Actualizar UI
                document.getElementById('walletStatus').innerHTML = `
                    Conectado: ${userAccount.slice(0,6)}...${userAccount.slice(-4)}<br>
                    <small>Saldo: ${parseFloat(balanceEth).toFixed(4)} ETH</small>
                `;
                document.getElementById('connectWallet').textContent = '‚úÖ Wallet Conectada';
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('connectWallet').classList.add('btn-success');
                
                // Verificar permisos de administrador
                await checkAdminPermissions();
                
                showStatus('üéâ Wallet conectada exitosamente!', 'success');
                
                // Cargar datos iniciales
                setTimeout(() => {
                    loadStats();
                    loadProjectsForSelects();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error completo en conexi√≥n:', error);
                
                let errorMessage = 'Error conectando wallet: ';
                
                if (error.code === 4001) {
                    errorMessage += 'Conexi√≥n rechazada por el usuario';
                } else if (error.code === -32002) {
                    errorMessage += 'Ya hay una solicitud pendiente en MetaMask';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Error desconocido';
                }
                
                showStatus('‚ùå ' + errorMessage, 'error');
                
                // Mostrar ayuda adicional
                setTimeout(() => {
                    showStatus('üí° Ayuda: Aseg√∫rate de estar en red Sepolia y tener ETH de prueba', 'info');
                }, 3000);
            }
        }

        // Verificar permisos de administrador
        async function checkAdminPermissions() {
            try {
                if (!contract || !userAccount) return;
                
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const isAdmin = await readOnlyContract.esAdministrador(userAccount);
                
                document.getElementById('createProject').disabled = !isAdmin;
                
                if (isAdmin) {
                    showStatus('‚úÖ Eres administrador - Puedes crear proyectos', 'success');
                } else {
                    showStatus('‚ÑπÔ∏è Usuario regular - Puedes registrar detecciones', 'info');
                }
                
            } catch (error) {
                console.error('Error verificando permisos:', error);
            }
        }

        // Crear proyecto
        async function createProject() {
            try {
                if (!contract) {
                    showStatus('Conecta tu wallet primero', 'error');
                    return;
                }
                
                const numeroProyecto = document.getElementById('numeroProyecto').value;
                const nombreProyecto = document.getElementById('nombreProyecto').value;
                const ubicacion = document.getElementById('ubicacion').value;
                const descripcion = document.getElementById('descripcion').value;
                const responsable = document.getElementById('responsable').value;
                const fechaFin = document.getElementById('fechaFin').value;
                
                if (!numeroProyecto || !nombreProyecto || !responsable || !fechaFin) {
                    showStatus('Por favor completa todos los campos obligatorios', 'error');
                    return;
                }
                
                const fechaFinTimestamp = Math.floor(new Date(fechaFin).getTime() / 1000);
                
                document.getElementById('createProject').disabled = true;
                document.getElementById('createProject').innerHTML = '<span class="loading"></span>Creando...';
                
                showStatus('Enviando transacci√≥n para crear proyecto...', 'info');
                
                const tx = await contract.crearProyecto(
                    parseInt(numeroProyecto),
                    nombreProyecto,
                    ubicacion || "",
                    descripcion || "",
                    responsable,
                    fechaFinTimestamp
                );
                
                showStatus(`Transacci√≥n enviada: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                
                showStatus(`‚úÖ Proyecto creado en bloque ${receipt.blockNumber}!`, 'success');
                
                // Limpiar formulario
                document.getElementById('numeroProyecto').value = '';
                document.getElementById('nombreProyecto').value = '';
                document.getElementById('ubicacion').value = '';
                document.getElementById('descripcion').value = '';
                document.getElementById('responsable').value = '';
                document.getElementById('fechaFin').value = '';
                
                // Recargar estad√≠sticas
                setTimeout(loadStats, 2000);
                
            } catch (error) {
                console.error('Error creando proyecto:', error);
                let errorMessage = 'Error creando proyecto: ';
                
                if (error.code === 'ACTION_REJECTED') {
                    errorMessage += 'Transacci√≥n cancelada por el usuario';
                } else if (error.reason) {
                    errorMessage += error.reason;
                } else {
                    errorMessage += error.message;
                }
                
                showStatus(errorMessage, 'error');
            } finally {
                document.getElementById('createProject').disabled = false;
                document.getElementById('createProject').innerHTML = 'Crear Proyecto';
            }
        }

        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                if (!provider) {
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const [totalProyectos, totalDetecciones, proyectosActivos] = await readOnlyContract.obtenerEstadisticas();
                
                document.getElementById('totalProjects').textContent = totalProyectos.toString();
                document.getElementById('activeProjects').textContent = proyectosActivos.toString();
                document.getElementById('totalDetections').textContent = totalDetecciones.toString();
                
                document.getElementById('statsContainer').style.display = 'flex';
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // Previsualizar imagen
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                currentImageFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
                
                document.getElementById('uploadToIPFS').disabled = false;
                showStatus(`Imagen seleccionada: ${file.name}`, 'info');
            }
        }

        // Subir imagen a IPFS (simulado - requiere configuraci√≥n real)
        async function uploadToIPFS() {
            try {
                if (!currentImageFile) {
                    showStatus('Selecciona una imagen primero', 'error');
                    return;
                }
                
                document.getElementById('uploadToIPFS').disabled = true;
                document.getElementById('uploadToIPFS').innerHTML = '<span class="loading"></span>Subiendo...';
                
                // SIMULACI√ìN - En producci√≥n, aqu√≠ subir√≠as a IPFS real
                // Por ahora generamos un hash simulado
                const simulatedHash = `Qm${Math.random().toString(36).substr(2, 44)}`;
                
                currentIPFSHash = simulatedHash;
                
                document.getElementById('ipfsHash').innerHTML = `
                    <h4>‚úÖ Imagen subida a IPFS:</h4>
                    <p><strong>Hash:</strong> ${simulatedHash}</p>
                    <p><strong>URL:</strong> https://ipfs.io/ipfs/${simulatedHash}</p>
                `;
                document.getElementById('ipfsHash').style.display = 'block';
                
                document.getElementById('registerDetection').disabled = false;
                
                showStatus('Imagen subida exitosamente a IPFS', 'success');
                
            } catch (error) {
                console.error('Error subiendo a IPFS:', error);
                showStatus('Error subiendo imagen: ' + error.message, 'error');
            } finally {
                document.getElementById('uploadToIPFS').disabled = false;
                document.getElementById('uploadToIPFS').innerHTML = 'üì§ Subir a IPFS';
            }
        }

        // Registrar detecci√≥n
        async function registerDetection() {
            try {
                if (!contract) {
                    showStatus('Conecta tu wallet primero', 'error');
                    return;
                }
                
                const numeroProyecto = document.getElementById('proyectoSelect').value;
                const deteccionPersona = document.getElementById('deteccionPersona').value;
                const equipos = document.getElementById('equipos').value;
                const fechaRegistro = document.getElementById('fechaRegistro').value;
                
                if (!numeroProyecto || !deteccionPersona || !equipos || !fechaRegistro || !currentIPFSHash) {
                    showStatus('Completa todos los campos y sube la imagen a IPFS', 'error');
                    return;
                }
                
                document.getElementById('registerDetection').disabled = true;
                document.getElementById('registerDetection').innerHTML = '<span class="loading"></span>Registrando...';
                
                showStatus('Enviando transacci√≥n...', 'info');
                
                const tx = await contract.registrarDeteccionIA(
                    parseInt(numeroProyecto),
                    deteccionPersona,
                    equipos,
                    fechaRegistro,
                    currentIPFSHash
                );
                
                showStatus(`Transacci√≥n enviada: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                
                showStatus(`‚úÖ Detecci√≥n registrada en bloque ${receipt.blockNumber}!`, 'success');
                
                // Limpiar formulario
                document.getElementById('deteccionPersona').value = '';
                document.getElementById('equipos').value = '';
                document.getElementById('imagenFile').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                document.getElementById('ipfsHash').style.display = 'none';
                currentImageFile = null;
                currentIPFSHash = null;
                
                setTimeout(loadStats, 2000);
                
            } catch (error) {
                console.error('Error registrando detecci√≥n:', error);
                let errorMessage = 'Error registrando detecci√≥n: ';
                
                if (error.code === 'ACTION_REJECTED') {
                    errorMessage += 'Transacci√≥n cancelada por el usuario';
                } else if (error.reason) {
                    errorMessage += error.reason;
                } else {
                    errorMessage += error.message;
                }
                
                showStatus(errorMessage, 'error');
            } finally {
                document.getElementById('registerDetection').disabled = true;
                document.getElementById('registerDetection').innerHTML = 'Registrar Detecci√≥n';
            }
        }

        // Cargar proyectos para los selects
        async function loadProjectsForSelects() {
            try {
                if (!provider) {
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const totalProyectos = await readOnlyContract.totalProyectos();
                
                const proyectoSelect = document.getElementById('proyectoSelect');
                const consultaProyecto = document.getElementById('consultaProyecto');
                
                // Limpiar opciones existentes
                proyectoSelect.innerHTML = '<option value="">Selecciona un proyecto</option>';
                consultaProyecto.innerHTML = '<option value="">Selecciona un proyecto</option>';
                
                // Cargar proyectos (limitamos a 20 para evitar problemas)
                const limite = Math.min(parseInt(totalProyectos.toString()), 20);
                
                for (let i = 1; i <= limite; i++) {
                    try {
                        const [numero, nombre, activo,] = await readOnlyContract.obtenerResumenProyecto(i);
                        
                        if (activo) {
                            const option1 = new Option(`${numero} - ${nombre}`, numero);
                            const option2 = new Option(`${numero} - ${nombre}`, numero);
                            
                            proyectoSelect.add(option1);
                            consultaProyecto.add(option2);
                        }
                    } catch (error) {
                        // Proyecto puede no existir, continuar
                        continue;
                    }
                }
                
            } catch (error) {
                console.error('Error cargando proyectos:', error);
            }
        }

        // Funciones de consulta
        async function getLastDetection() {
            try {
                if (!provider) {
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const [numeroProyecto, deteccionPersona, equipos, fechaRegistro, imagenIPFS, registradoPor, timestamp] = await readOnlyContract.leerUltimaDeteccion();
                
                const fecha = new Date(parseInt(timestamp.toString()) * 1000).toLocaleString();
                
                document.getElementById('queryResults').innerHTML = `
                    <div class="message-display">
                        <h4>üìã √öltima Detecci√≥n:</h4>
                        <p><strong>Proyecto:</strong> ${numeroProyecto}</p>
                        <p><strong>Personas:</strong> ${deteccionPersona}</p>
                        <p><strong>Equipos:</strong> ${equipos}</p>
                        <p><strong>Fecha Registro:</strong> ${fechaRegistro}</p>
                        <p><strong>IPFS:</strong> ${imagenIPFS}</p>
                        <p><strong>Registrado por:</strong> ${registradoPor}</p>
                        <p><strong>Timestamp:</strong> ${fecha}</p>
                    </div>
                `;
                
                showStatus('√öltima detecci√≥n cargada', 'success');
                
            } catch (error) {
                console.error('Error obteniendo √∫ltima detecci√≥n:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Cargar imagen desde IPFS
        async function loadIPFSImage() {
            const ipfsHash = document.getElementById('ipfsHashInput').value;
            
            if (!ipfsHash) {
                showStatus('Ingresa un hash IPFS', 'error');
                return;
            }
            
            const container = document.getElementById('ipfsImageContainer');
            container.innerHTML = `
                <div class="message-display">
                    <h4>üñºÔ∏è Imagen desde IPFS:</h4>
                    <p><strong>Hash:</strong> ${ipfsHash}</p>
                    <img src="https://ipfs.io/ipfs/${ipfsHash}" class="ipfs-image" alt="Imagen desde IPFS" 
                         onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" width=\\"200\\" height=\\"200\\"><rect width=\\"200\\" height=\\"200\\" fill=\\"#f0f0f0\\"/><text x=\\"100\\" y=\\"100\\" text-anchor=\\"middle\\" fill=\\"#666\\">Imagen no encontrada</text></svg>'">
                </div>
            `;
            
            showStatus('Cargando imagen desde IPFS...', 'info');
        }

        // Funci√≥n de diagn√≥stico completo
        async function runDiagnosis() {
            const results = document.getElementById('diagnosisResults');
            results.style.display = 'block';
            results.innerHTML = '<div class="loading"></div> Ejecutando diagn√≥stico...';
            
            let diagnosis = '<h4>üîç Diagn√≥stico del Sistema:</h4>';
            
            try {
                // 1. Verificar MetaMask
                if (typeof window.ethereum !== 'undefined') {
                    diagnosis += '‚úÖ MetaMask: Instalado<br>';
                    
                    // 2. Verificar conexi√≥n
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) {
                            diagnosis += `‚úÖ Wallet: Conectada (${accounts[0].slice(0,6)}...${accounts[0].slice(-4)})<br>`;
                        } else {
                            diagnosis += '‚ö†Ô∏è Wallet: No conectada<br>';
                        }
                    } catch (e) {
                        diagnosis += '‚ùå Error verificando cuentas: ' + e.message + '<br>';
                    }
                    
                    // 3. Verificar red
                    try {
                        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                        const chainIdDecimal = parseInt(chainId, 16);
                        
                        if (chainId === SEPOLIA_CHAIN_ID) {
                            diagnosis += '‚úÖ Red: Sepolia (11155111)<br>';
                        } else {
                            diagnosis += `‚ùå Red: ${chainIdDecimal} (Se requiere Sepolia: 11155111)<br>`;
                        }
                    } catch (e) {
                        diagnosis += '‚ùå Error verificando red: ' + e.message + '<br>';
                    }
                    
                    // 4. Verificar saldo
                    try {
                        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                        if (accounts.length > 0) {
                            const tempProvider = new ethers.BrowserProvider(window.ethereum);
                            const balance = await tempProvider.getBalance(accounts[0]);
                            const balanceEth = ethers.formatEther(balance);
                            
                            if (parseFloat(balanceEth) > 0.001) {
                                diagnosis += `‚úÖ Saldo: ${parseFloat(balanceEth).toFixed(4)} ETH<br>`;
                            } else {
                                diagnosis += `‚ö†Ô∏è Saldo bajo: ${parseFloat(balanceEth).toFixed(6)} ETH<br>`;
                                diagnosis += 'üí° Consigue ETH gratis: <a href="https://sepoliafaucet.com/" target="_blank">sepoliafaucet.com</a><br>';
                            }
                        }
                    } catch (e) {
                        diagnosis += '‚ùå Error verificando saldo: ' + e.message + '<br>';
                    }
                    
                    // 5. Verificar contrato
                    try {
                        const tempProvider = new ethers.BrowserProvider(window.ethereum);
                        const code = await tempProvider.getCode(CONTRACT_ADDRESS);
                        
                        if (code !== '0x') {
                            diagnosis += '‚úÖ Contrato: Desplegado correctamente<br>';
                        } else {
                            diagnosis += '‚ùå Contrato: No encontrado en esta red<br>';
                        }
                        
                        // Probar funci√≥n de lectura
                        const tempContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, tempProvider);
                        const totalProyectos = await tempContract.totalProyectos();
                        diagnosis += `‚úÖ Funci√≥n de lectura: ${totalProyectos} proyectos registrados<br>`;
                        
                    } catch (e) {
                        diagnosis += '‚ùå Error verificando contrato: ' + e.message + '<br>';
                    }
                    
                } else {
                    diagnosis += '‚ùå MetaMask: No instalado<br>';
                    diagnosis += 'üí° Instalar desde: <a href="https://metamask.io/download/" target="_blank">metamask.io</a><br>';
                }
                
                // 6. Verificar IPFS (simulado)
                diagnosis += '‚úÖ IPFS: Configurado (modo simulaci√≥n)<br>';
                
                diagnosis += '<br><strong>üöÄ Acciones recomendadas:</strong><br>';
                
                if (typeof window.ethereum === 'undefined') {
                    diagnosis += '1. Instalar MetaMask<br>';
                } else {
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (chainId !== SEPOLIA_CHAIN_ID) {
                        diagnosis += '1. Cambiar a red Sepolia<br>';
                    }
                    
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length === 0) {
                        diagnosis += '2. Conectar wallet<br>';
                    }
                    
                    if (accounts.length > 0) {
                        const tempProvider = new ethers.BrowserProvider(window.ethereum);
                        const balance = await tempProvider.getBalance(accounts[0]);
                        const balanceEth = ethers.formatEther(balance);
                        
                        if (parseFloat(balanceEth) < 0.001) {
                            diagnosis += '3. Conseguir ETH de prueba<br>';
                        }
                    }
                }
                
            } catch (error) {
                diagnosis += '‚ùå Error en diagn√≥stico: ' + error.message + '<br>';
            }
            
            results.innerHTML = `<div class="message-display">${diagnosis}</div>`;
        }

        // Funciones adicionales que pueden necesitarse
        async function getProjectInfo() {
            const numeroProyecto = document.getElementById('consultaProyecto').value;
            if (!numeroProyecto) {
                showStatus('Selecciona un proyecto', 'error');
                return;
            }
            
            try {
                if (!provider) {
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const [nombre, ubicacion, descripcion, responsable] = await readOnlyContract.obtenerProyectoBasico(parseInt(numeroProyecto));
                const [fechaInicio, fechaFin, activo, cantidadDetecciones] = await readOnlyContract.obtenerProyectoEstado(parseInt(numeroProyecto));
                
                const fechaInicioStr = new Date(parseInt(fechaInicio.toString()) * 1000).toLocaleDateString();
                const fechaFinStr = new Date(parseInt(fechaFin.toString()) * 1000).toLocaleDateString();
                
                document.getElementById('queryResults').innerHTML = `
                    <div class="message-display">
                        <h4>üèóÔ∏è Informaci√≥n del Proyecto ${numeroProyecto}:</h4>
                        <p><strong>Nombre:</strong> ${nombre}</p>
                        <p><strong>Ubicaci√≥n:</strong> ${ubicacion}</p>
                        <p><strong>Descripci√≥n:</strong> ${descripcion}</p>
                        <p><strong>Responsable:</strong> ${responsable}</p>
                        <p><strong>Fecha Inicio:</strong> ${fechaInicioStr}</p>
                        <p><strong>Fecha Fin:</strong> ${fechaFinStr}</p>
                        <p><strong>Estado:</strong> ${activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</p>
                        <p><strong>Detecciones:</strong> ${cantidadDetecciones}</p>
                    </div>
                `;
                
                showStatus('Informaci√≥n del proyecto cargada', 'success');
                
            } catch (error) {
                console.error('Error obteniendo info del proyecto:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        async function getProjectDetections() {
            const numeroProyecto = document.getElementById('consultaProyecto').value;
            if (!numeroProyecto) {
                showStatus('Selecciona un proyecto', 'error');
                return;
            }
            
            try {
                if (!provider) {
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const detecciones = await readOnlyContract.obtenerDeteccionesProyecto(parseInt(numeroProyecto));
                
                let html = `
                    <div class="message-display">
                        <h4>üìä Detecciones del Proyecto ${numeroProyecto}:</h4>
                        <p><strong>Total:</strong> ${detecciones.length}</p>
                `;
                
                if (detecciones.length > 0) {
                    html += '<p><strong>IDs de Detecciones:</strong> ';
                    html += detecciones.slice(0, 10).map(id => id.toString()).join(', ');
                    if (detecciones.length > 10) {
                        html += ` ... y ${detecciones.length - 10} m√°s`;
                    }
                    html += '</p>';
                }
                
                html += '</div>';
                
                document.getElementById('queryResults').innerHTML = html;
                showStatus('Detecciones del proyecto cargadas', 'success');
                
            } catch (error) {
                console.error('Error obteniendo detecciones:', error);
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // Funci√≥n para cargar proyectos (para la pesta√±a de proyectos)
        async function loadProjects() {
            try {
                if (!provider) {
                    provider = new ethers.BrowserProvider(window.ethereum);
                }
                
                const readOnlyContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const totalProyectos = await readOnlyContract.totalProyectos();
                
                const projectsList = document.getElementById('projectsList');
                projectsList.innerHTML = '';
                
                const limite = Math.min(parseInt(totalProyectos.toString()), 20);
                
                for (let i = 1; i <= limite; i++) {
                    try {
                        const [numero, nombre, activo, cantidadDetecciones] = await readOnlyContract.obtenerResumenProyecto(i);
                        
                        const card = document.createElement('div');
                        card.className = `project-card ${activo ? 'active' : 'inactive'}`;
                        card.innerHTML = `
                            <h4>Proyecto ${numero}</h4>
                            <p><strong>Nombre:</strong> ${nombre}</p>
                            <p><strong>Estado:</strong> ${activo ? '‚úÖ Activo' : '‚ùå Inactivo'}</p>
                            <p><strong>Detecciones:</strong> ${cantidadDetecciones}</p>
                        `;
                        
                        projectsList.appendChild(card);
                    } catch (error) {
                        continue;
                    }
                }
                
                showStatus(`${limite} proyectos cargados`, 'success');
                
            } catch (error) {
                console.error('Error cargando proyectos:', error);
                showStatus('Error cargando proyectos: ' + error.message, 'error');
            }
        }
    </script>
